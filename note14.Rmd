---
title: "note14"
output: html_notebook
---

# 14 R6

## 14.1 Introduction

```{r}
library(R6)
```

## 14.2 Classes and methods

```{r}
Accumulator <- R6Class("Accumulator", list(
  sum = 0,
  add = function(x = 1) {
    self$sum <- self$sum + x
    invisible(self)
  }
))
Accumulator
```

```{r}
x <- Accumulator$new()
x$add(4)
x$sum
```

```{r}
x$add(10)$add(10)$sum
```

```{r}
Person <- R6Class("Person", list(
  name = NULL,
  age = NA,
  initialize = function(name, age = NA) {
    stopifnot(is.character(name), length(name) == 1)
    stopifnot(is.numeric(age), length(age) == 1)

    self$name <- name
    self$age <- age
  }
))

try(hadley <- Person$new("Hadley", age = "thirty-eight"))
hadley <- Person$new("Hadley", age = 38)
hadley
```

```{r}
Person <- R6Class("Person", list(
  name = NULL,
  age = NA,
  initialize = function(name, age = NA) {
    stopifnot(is.character(name), length(name) == 1)
    stopifnot(is.numeric(age), length(age) == 1)

    self$name <- name
    self$age <- age
  },
  print = function(...) {
    cat("Person: \n")
    cat("  Name: ", self$name, "\n", sep = "")
    cat("  Age: ", self$age, "\n", sep = "")
    invisible(self)
  }
))

hadley2 <- Person$new("Hadley", age = 38)
hadley2
```

```{r}
hadley
```

```{r}
hadley2
```

```{r}
Accumulator <- R6Class("Accumulator")
Accumulator$set("public", "sum", 0)
Accumulator$set("public", "add", function(x = 1) {
  self$sum <- self$sum + x
  invisible(self)
})
```

```{r}
AccumulatorChatty <- R6Class(
  "AccumulatorChatty",
  inherit = Accumulator,
  public = list(
    add = function(x = 1) {
      cat("Adding ", x, "\n", sep = "")
      super$add(x = x)
    }
  )
)
x2 <- AccumulatorChatty$new()
x2$add(10)$add(1)$sum
```

```{r}
class(hadley2)
```

```{r}
names(hadley2)
```

```{r}
BankAccount <- R6Class(
  classname = "BankAccount",
  public = list(
    balance = 0,
    deposit = function(dep = 0) {
      self$balance <- self$balance + dep
      invisible(self)
    },
    withdraw = function(draw) {
      self$balance <- self$balance - draw
      invisible(self)
    }
  )
)

my_account <- BankAccount$new()
my_account$balance
my_account$
  deposit(5)$
  withdraw(15)$
  balance
```

```{r}
BankAccountStrict <- R6Class(
  classname = "BankAccountStrict",
  inherit = BankAccount,
  public = list(
    withdraw = function(draw = 0) {
      if (self$balance - draw < 0) {
        stop("Your `withdraw` must be smaller ",
          "than your `balace`.",
          call. = FALSE
        )
      }
      super$withdraw(draw = draw)
    }
  )
)

my_strict_account <- BankAccountStrict$new()
my_strict_account$balance
try(my_strict_account$
  deposit(5)$
  withdraw(15))
my_strict_account$balance
```

```{r}
BankAccountCharging <- R6Class(
  classname = "BankAccountCharging",
  inherit = BankAccount,
  public = list(
    withdraw = function(draw = 0) {
      if (self$balance - draw < 0) {
        draw <- draw + 1
      }
      super$withdraw(draw = draw)
    }
  )
)

my_charging_account <- BankAccountCharging$new()
my_charging_account$balance

my_charging_account$
  deposit(5)$
  withdraw(15)$
  withdraw(0)$balance
```

```{r}
suit <- c("SPADE", "HEARTS", "DIAMOND", "CLUB")
value <- c("A", 2:10, "J", "Q", "K")
cards <- paste(rep(value, 4), suit)
cards
```

```{r}
ShuffledDeck <- R6Class(
  classname = "ShuffledDeck",
  public = list(
    deck = NULL,
    initialize = function(deck = cards) {
      self$deck <- sample(deck)
    },
    reshuffle = function() {
      self$deck <- sample(cards)
      invisible(self)
    },
    n = function() {
      length(self$deck)
    },
    draw = function(n = 1) {
      if (n > self$n()) {
        stop("Only ", self$n(), " cards remaining.", call. = FALSE)
      }
      output <- self$deck[seq_len(n)]
      self$deck <- self$deck[-seq_len(n)]
      output
    }
  )
)

my_deck <- ShuffledDeck$new()

my_deck$draw(52)
try(my_deck$draw(10))
```

```{r}
my_deck$reshuffle()$draw(5)
my_deck$reshuffle()$draw(5)
```

```{r}
Timezone <- R6Class(
  classname = "Timezone",
  public = list(
    get = function() {
      Sys.timezone()
    },
    set = function(value) {
      stopifnot(value %in% OlsonNames())

      old <- self$get()
      Sys.setenv(TZ = value)
      invisible(old)
    }
  )
)

# tz <- Timezone$new()
# old <- tz$set("Antarctica/South_Pole")
# tz$get()
# tz$set(old)
# tz$get()
```

```{r}
WorkingDirectory <- R6Class(
  classname = "WorkingDirectory",
  public = list(
    get = function() {
      getwd()
    },
    set = function(value) {
      setwd(value)
    }
  )
)

wd <- WorkingDirectory$new()
wd$get()
# wd$set("~")
# wd$get()
```

## 14.3 Controlling access

## 14.4 Reference semantics

## 14.5 Why R6?
